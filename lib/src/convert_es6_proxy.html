<!--
Copyright (c) 2015, the Dart project authors.  Please see the AUTHORS file
for details. All rights reserved. Use of this source code is governed by a
BSD-style license that can be found in the LICENSE file.
-->
<link rel="import" href="convert.html">
<script>
  Polymer.PolymerInterop = Polymer.PolymerInterop || {};
  Polymer.PolymerInterop.ES6 = Polymer.PolymerInterop.ES6 || {};

  (function(ES6) {

    ES6.Unsupported = {};

    var _throwShouldBeOverridden = function() {
      throw new Error("This method should be overridden by dart implementation");
    };

    ES6._dartArrayGet = _throwShouldBeOverridden;
    ES6._dartArrayPut = _throwShouldBeOverridden;
    ES6._dartArrayLength = _throwShouldBeOverridden;
    ES6._dartArraySetLength = _throwShouldBeOverridden;

    ES6._dartGet = _throwShouldBeOverridden;
    ES6._dartPut = _throwShouldBeOverridden;
    ES6._dartKeys = _throwShouldBeOverridden;

    /**
     * List ES6JsProxy support
     */

    var arrayCommonBehaviors = {
      '__dartClass__' : function(instance) { return instance; },
      '__isES6Proxy__' : function(instance) { return true; },

      'length' : function(instance) { return ES6._dartArrayLength(instance); }
    };

    // TODO(dam0vment) investigate if overriding only get/setOwnPropertyDescriptor and ownKeys
    // is enough (all the other methods could just depend on those)
    ES6.createES6JsProxyForArray = function(instance) {
      return new Proxy([],{
        'get' : function(target,propertyName,proxy) {

          if (arrayCommonBehaviors.hasOwnProperty(propertyName)) {
            return arrayCommonBehaviors[propertyName].call(this,instance);
          }

          if (isNaN(propertyName.toString())) {
            return target[propertyName];
          }

          return ES6._dartArrayGet(instance,+propertyName);
        },

        'has' : function(target,prop) {
          var len = ES6._dartArrayLength(instance);
          var pos = +prop;
          if (!isNaN(prop) && pos>=0 && pos < len ) {
            return true;
          }
          return prop in target;
        },

        'getOwnPropertyDescriptor': function(target, prop) {
          var len = ES6._dartArrayLength(instance);
          var pos = +prop;
          if (!isNaN(prop) && pos>=0 && pos < len ) {
            return { configurable: true, enumerable: true, value: ES6._dartArrayGet(instance,pos) };
          }
          return Object.getOwnPropertyDescriptor(target,prop);
        },

        'set' : function(target,propertyName,value,proxy) {
          if (propertyName.toString() == 'length') {
            ES6._dartArraySetLength(instance,+value);
          } else if (isNaN(propertyName.toString())) {
            target[propertyName] = value;
          } else {
            ES6._dartArrayPut(instance,+propertyName,value);
          }
          return true;
        },
        'ownKeys' : function(target) {
          var x = Object.getOwnPropertyNames(target).slice();
          for (var i = 0 ;i<ES6._dartArrayLength(instance);i++) {
            x.push(""+i);
          }
          return x;
        }
      });
    };


    /**
     * Maps ES6JsProxy support
     */

    var mapCommonBehaviors = {
      '__dartClass__' : function(instance) { return instance; },
      '__isES6Proxy__' : function(instance) { return true; }
    };

    ES6.createES6JsProxyForMaps = function(instance) {
      return new Proxy({},{
        'has' : function(target,prop){
          return ES6._dartKeys(instance).indexOf(prop) >= 0;
        },
        getOwnPropertyDescriptor: function(target, prop) {
          if (ES6._dartKeys(instance).indexOf(prop) >= 0) {
            return { configurable: true, enumerable: true, value: ES6._dartGet(instance,prop) };
          }
          return Object.getOwnPropertyDescriptor(target,prop);
        },

        'get' : function(target,propertyName,proxy) {

          // target first! (because of '__proto__' , 'constructor' , and dart interop internals ... )
          var _cache = target[propertyName];
          if(_cache) {
            return _cache;
          }

          if (mapCommonBehaviors.hasOwnProperty(propertyName)) {
            return mapCommonBehaviors[propertyName].call(this,instance);
          }

          return ES6._dartGet(instance,propertyName);
        },

        'set' : function(target,propertyName,value,proxy) {
          ES6._dartPut(instance,propertyName,value);
          return true;
        },

        'ownKeys' : function(target) {
          return Object.getOwnPropertyNames(target).concat(ES6._dartKeys(instance));
        }
      });
    };

  })(Polymer.PolymerInterop.ES6);
</script>
